<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>River Gauges Map</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="" crossorigin=""/>
  <style>
    html, body, #map { height: 100%; margin: 0; }
    .legend { background: white; padding: 8px; border-radius: 8px; line-height: 1.4; }
    .legend div { display: flex; align-items: center; gap: 6px; }
    .dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; }
    .in { background: #22c55e; }       /* green */
    .out { background: #9ca3af; }      /* gray */
    .good-low { background: #fde047; } /* yellow */
    .shitty-medium { background: #92400e; } /* brown */
    .good-medium { background: #86efac; } /* light green */
    .good-high { background: #22c55e; } /* green */
    .too-high { background: #ef4444; } /* red */
  </style>
</head>
<body>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="" crossorigin=""></script>
  <script>
    const map = L.map('map');
    const tiles = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 18,
      attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    // Try geolocate for a nice starting view, fallback to SE US
    function setDefaultView() {
      map.setView([34.7, -86.6], 7); // Alabama / Tennessee area
    }
    navigator.geolocation?.getCurrentPosition(
      pos => map.setView([pos.coords.latitude, pos.coords.longitude], 9),
      setDefaultView,
      { timeout: 2000 }
    );
    setTimeout(setDefaultView, 2500);

    // Load gauges from your API; adjust to your actual endpoint.
    fetch('/api/gauges')
      .then(r => r.json())
      .then(gauges => {
        const group = L.featureGroup();
        gauges.forEach(g => {
          const colorClass = (g.css_class || g.status || 'out');
          const marker = L.circleMarker([g.lat, g.lon], { radius: 7, weight: 1 });
          marker.bindPopup(`
            <b>${g.name}</b><br>
            ${g.level_cfs ?? '?'} CFS<br>
            <small>${g.trend ?? ''}</small><br>
            <a href="${g.link ?? '#'}" target="_blank">Open detail</a>
          `);
          marker.addTo(group);
        });
        group.addTo(map);
        if (group.getBounds().isValid()) map.fitBounds(group.getBounds().pad(0.2));
      })
      .catch(() => {
        // Friendly empty-state
        const div = L.control({position: 'topright'});
        div.onAdd = () => {
          const el = L.DomUtil.create('div', 'legend');
          el.innerHTML = '<b>No /api/gauges</b><br>Wire this to return JSON like: ' +
            '<pre style="margin:0">[{"id":"02399200","name":"LRC","lat":34.4,"lon":-85.6,"css_class":"good-medium","level_cfs":900,"link":"/site/02399200"}]</pre>';
          return el;
        };
        div.addTo(map);
      });

    // Legend
    const legend = L.control({position: 'bottomright'});
    legend.onAdd = () => {
      const el = L.DomUtil.create('div', 'legend');
      el.innerHTML = `
        <div><span class="dot in"></span> IN</div>
        <div><span class="dot out"></span> OUT</div>
        <div><span class="dot good-low"></span> Good low</div>
        <div><span class="dot shitty-medium"></span> Shitty medium</div>
        <div><span class="dot good-medium"></span> Good medium</div>
        <div><span class="dot good-high"></span> Good high</div>
        <div><span class="dot too-high"></span> Too high</div>
      `;
      return el;
    };
    legend.addTo(map);
  </script>
</body>
</html>
